<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>خدمتي - لوحة التحكم الإدارية</title>
    <link
      href="https://fonts.googleapis.com/css?family=Poppins:400,500,700,800&display=swap"
      rel="stylesheet"
    />
    <link
      href="./assets/plugins/bootstrap/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="./assets/plugins/font-awesome/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="./assets/plugins/perfectscroll/perfect-scrollbar.css"
      rel="stylesheet"
    />
    <link href="./assets/css/main.min.css" rel="stylesheet" />
    <link href="./assets/css/custom.css" rel="stylesheet" />
    <link href="./assets/css/app.css" rel="stylesheet" />
  </head>
  <body>
    <div class="loader">
      <div class="spinner-grow text-primary" role="status">
        <span class="sr-only">Loading...</span>
      </div>
    </div>

    <div class="page-container">
      <div class="page-header">
        <nav class="navbar navbar-expand-lg d-flex justify-content-between">
          <div class="" id="navbarNav">
            <ul class="navbar-nav" id="leftNav">
              <li class="nav-item">
                <a class="nav-link" id="sidebar-toggle" href="#"
                  ><i data-feather="arrow-left"></i
                ></a>
              </li>
            </ul>
          </div>
          <div class="logo">
            <a class="navbar-brand" href="./orders.html"></a>
          </div>
          <div class="" id="headerNav">
            <ul class="navbar-nav">
              <li class="nav-item dropdown">
                <a
                  class="nav-link search-dropdown"
                  href="#"
                  id="searchDropDown"
                  role="button"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                  ><i data-feather="search"></i
                ></a>
                <div
                  class="dropdown-menu dropdown-menu-end dropdown-lg search-drop-menu"
                  aria-labelledby="searchDropDown"
                >
                  <form>
                    <input
                      class="form-control"
                      type="text"
                      placeholder="Type something.."
                      aria-label="Search"
                    />
                  </form>
                </div>
              </li>

              <li class="nav-item dropdown">
                <a
                  class="nav-link profile-dropdown"
                  href="#"
                  id="profileDropDown"
                  role="button"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                  ><img
                    src="./assets/images/avatars/profile-image.png"
                    alt=""
                /></a>
                <div
                  class="dropdown-menu dropdown-menu-end profile-drop-menu"
                  aria-labelledby="profileDropDown"
                >
                  
                  <a class="dropdown-item" href="./index.html"
                    ><i data-feather="log-out"></i>تسجيل الخروج</a
                  >
                </div>
              </li>
            </ul>
          </div>
        </nav>
      </div>
      <div class="page-sidebar">
        <ul class="list-unstyled accordion-menu">
          <li>
            <a href="./orders.html"><i data-feather="package"></i>الطلبات</a>
          </li>
          <li>
            <a href="./workers.html"
              ><i data-feather="user-check"></i>قائمة التقنيين</a
            >
          </li>
          <li>
            <a href="./history.html"
              ><i data-feather="hard-drive"></i>الطلبات المنجزة</a
            >
          </li>
          <li>
            <a href="./new.html"
              ><i data-feather="folder-plus"></i>الطلبات الواردة</a
            >
          </li>
        </ul>
      </div>
      <div class="page-content">
        <div class="main-wrapper">
          <div class="d-flex flex-column w-100">
            <div class="container-wrapper">
              <div
                class="d-flex align-items-center justify-content-between p pb-6"
              >
                <h2 class="m-0">سجل الطلبات</h2>
                <div class="d-flex align-items-center">
                  <button
                    class="btn btn-primary btn-sm border border-3"
                    data-toggle="modal"
                    data-target="#DeleteOrderModal"
                  >
                    <i data-feather="package" class="align-middle md-18"></i>
                    <span class="align-middle">حذف الطلب</span>
                  </button>
                </div>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table table-responsive bg-white m-0">
                <thead class="thead-light">
                  <tr>
                    <th class="text-uppercase">اسم الزبون</th>
                    <th class="text-uppercase">بريد الزبون</th>
                    <th class="text-uppercase">اسم العامل</th>
                    <th class="text-uppercase">بريد العامل</th>
                    <th class="text-uppercase">الخدمات</th>
                    <th class="text-uppercase">السعر</th>
                  </tr>
                </thead>
                <tbody id="tbody1"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Javascripts -->
    <script src="./assets/plugins/jquery/jquery-3.4.1.min.js"></script>
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="./assets/plugins/bootstrap/js/bootstrap.min.js"></script>
    <script src="./assets/vendor/bootstrap.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="./assets/plugins/perfectscroll/perfect-scrollbar.min.js"></script>
    <script src="./assets/js/main.min.js"></script>
    <script src="./assets/vendor/popper.js"></script>
    <script src="./assets/vendor/simplebar.js"></script>
    <script src="./assets/vendor/Chart.min.js"></script>
    <script src="./assets/vendor/moment.min.js"></script>
    <script src="./assets/vendor/dateformat.js"></script>
    <script src="./assets/vendor/bootstrap-datepicker.min.js"></script>
    <script>
      window.theme = "default";
    </script>
    <script src="./assets/js/color_variables.js"></script>
    <script src="./assets/js/app.js"></script>
    <script src="./assets/vendor/dom-factory.js"></script>
    <script src="./assets/vendor/material-design-kit.js"></script>

    <div
      class="modal fade"
      id="DeleteOrderModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="newClientModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="newClientModalLabel">حذف الطلب</h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="form-row">
              <div class="form-group col-md-6">
                <label>بريد الزبون</label>
                <input
                  required
                  type="email"
                  id="client-email"
                  class="form-control"
                  placeholder="بريد الزبون"
                />
              </div>
              <div class="form-group col-md-6">
                <label>بريد العامل</label>
                <input
                  required
                  type="email"
                  id="worker-email"
                  class="form-control"
                  placeholder="بريد العامل"
                />
              </div>
              <div class="form-group col-md-6">
                <label>الخدمة</label>
                <input
                  required
                  type="email"
                  id="service"
                  class="form-control"
                  placeholder="الخدمة"
                />
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary border"
              data-dismiss="modal"
            >
              <i data-feather="x" class="md-18 align-middle"></i>
              <span class="align-middle">إغلاق</span>
            </button>
            <button
              data-dismiss="modal"
              type="button"
              class="btn btn-primary border"
              id="addbtn2"
            >
              <i data-feather="delete" class="md-18 align-middle"></i>
              <span class="align-middle">حذف</span>
            </button>
          </div>
        </div>
      </div>
    </div>
    <script>
      (function () {
        "use strict";

        domFactory.handler.autoInit();

        var sidebarToggle = Array.prototype.slice.call(
          document.querySelectorAll('[data-toggle="sidebar"]')
        );

        sidebarToggle.forEach(function (toggle) {
          toggle.addEventListener("click", function (e) {
            var selector =
              e.currentTarget.getAttribute("data-target") || "#default-drawer";
            var drawer = document.querySelector(selector);
            if (drawer) {
              drawer.mdkDrawer.toggle();
            }
          });
        });

        window.top.location.hostname !== window.location.hostname &&
          (window.top.location = window.location);
      })();
    </script>

    <script src="./assets/vendor/select2.full.min.js"></script>

    <script type="module">
      var tbody = document.getElementById("tbody1");
      function AddItemToTable(
        clinetName,
        clinetEmail,
        workerName,
        workerEmail,
        service,
        price
      ) {
        let trow = document.createElement("tr");
        let td1 = document.createElement("td");
        let td2 = document.createElement("td");
        let td3 = document.createElement("td");
        let td4 = document.createElement("td");
        let td5 = document.createElement("td");
        let td6 = document.createElement("td");

        td1.innerHTML = clinetName;
        td2.innerHTML = clinetEmail;
        td3.innerHTML = workerName;
        td4.innerHTML = workerEmail;
        td5.innerHTML = service;
        td6.innerHTML = price + " DA";

        trow.appendChild(td1);
        trow.appendChild(td2);
        trow.appendChild(td3);
        trow.appendChild(td4);
        trow.appendChild(td5);
        trow.appendChild(td6);

        tbody.appendChild(trow);
      }

      function AddAllItemsToTable(user) {
        tbody.innerHTML = "";
        user.forEach((element) => {
          AddItemToTable(
            element.Client_Name,
            element.Client_Email,
            element.Worker_Name,
            element.Worker_Email,
            element.Service,
            element.Price
          );
        });
      }

      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js";
      import {
        getFirestore,
        doc,
        getDocs,
        onSnapshot,
        deleteDoc,
        query,
        where,
        collection,
      } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDwOmXya7PMnByQvQSEd96zFOQ485W4LKQ",
        authDomain: "khedmatipro.firebaseapp.com",
        databaseURL:
          "https://khedmatipro-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "khedmatipro",
        storageBucket: "khedmatipro.appspot.com",
        messagingSenderId: "889692484643",
        appId: "1:889692484643:web:b7753e20956df89db2ed96",
        measurementId: "G-TZP0H9CGK6",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      async function GetAllDataOnce() {
        try {
          const ordersRef = collection(db, "orders");
          const q = query(ordersRef, where("Price", "!=", ""));
          const snapshot = await getDocs(q);
          const orders = [];

          snapshot.forEach((doc) => {
            orders.push(doc.data());
          });
          AddAllItemsToTable(orders);
        } catch (error) {
          console.log("Error getting orders:", error);
          return [];
        }
      }
      let Client_Email = document.getElementById("client-email").value;
      let Worker_Email = document.getElementById("worker-email").value;
      let Service = document.getElementById("service").value;
      let Addbtn2 = document.getElementById("addbtn2");

      function deleteOrdersWithCriteria() {
        return new Promise(async (resolve, reject) => {
          try {
            const clientEmail = document.getElementById("client-email").value;
            const workerEmail = document.getElementById("worker-email").value;
            const service = document.getElementById("service").value;

            const ordersRef = collection(db, "orders");
            const q = query(
              ordersRef,
              where("Client_Email", "==", clientEmail),
              where("Worker_Email", "==", workerEmail),
              where("Service", "==", service)
            );
            const snapshot = await getDocs(q);

            snapshot.forEach(async (doc) => {
              await deleteDoc(doc.ref);
              console.log(`Document with ID ${doc.id} deleted successfully.`);
            });

            alert("Data added successfully.");
            window.location.reload();
            resolve();
          } catch (error) {
            console.log("Error deleting orders:", error);
            reject(error);
          }
        });
      }

      Addbtn2.addEventListener("click", deleteOrdersWithCriteria);

      window.onload = GetAllDataOnce;
    </script>
  </body>
</html>
